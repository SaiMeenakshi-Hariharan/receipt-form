<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title> Homegrown Produce Receipt Form </title>
<link href='https://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Arimo' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Hind:300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
<style>
    * {
        margin: 0; padding: 0;
    }

    body {
        font-family: 'Arial', sans-serif;
		overflow: hidden;
    }
	
	#container {
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  position: relative;
	  width: 100%;
	  height: 100vh;
	}

    .form-wrap {
        width: 500px;
        background: #FF00FF;
        padding: 40px 20px;
        box-sizing: border-box;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
    }
    
    h2 {
        text-align: center;
		justify-content: center;
        font-weight: bold;
		margin-bottom: 20px;
		white-space: nowrap;
    }
	
	h4 {
        text-align: center;
		justify-content: center;
        font-weight: normal;
		margin-bottom: 20px;
		word-wrap: break-word;
    }
	
	h5 {
        text-align: center;
		justify-content: center;
        font-weight: normal;
		margin-bottom: 20px;
		word-wrap: break-word;
    }
    
    input {
        width: 220px;
        background: none;
        border: 1px solid #fff;
        border-radius: 3px;
        padding: 6px 15px;
        box-sizing: border-box;
        margin-bottom: 10px;
        font-size: 16px;
		float: right;
    }
	
	select {
        width: 220px;
        background: none;
        border: 1px solid #fff;
        border-radius: 3px;
        padding: 6px 15px;
        box-sizing: border-box;
        margin-bottom: 10px;
        font-size: 16px;
		float: right;
    }
	
	label {
		font-size: 13px;
	}
	
	.quantext {
        width: 220px;
        background: none;
        border: 1px solid #fff;
        border-radius: 3px;
        padding: 6px 15px;
        box-sizing: border-box;
        margin-bottom: 10px;
        font-size: 16px;
		float: left;
    }
	
	.shortselect {
        width: 40px;
        background: none;
        border: 1px solid #fff;
        border-radius: 3px;
        padding: 6px 15px;
        box-sizing: border-box;
        margin-bottom: 10px;
        font-size: 16px;
		float: right;
    }

    .centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .btn {
      position: relative;
	  z-index: 10;
	  width: 200px;
	  height: 60px;
	  border: 1px solid rgba(255, 255, 255, .5);
	  border-radius: 30px;
	  background-color: #717171;
	  color: #fff;
	  margin-left: 130px;
      margin-bottom: 20px;
	  padding: 6px 15px;
	  font-size: 1.25rem;
	  letter-spacing: 1px;
	  outline: none;
	  cursor: pointer;
    }
	
	.btn::before {
	  position: absolute;
	  top: 15px;
	  left: 50px;
	  z-index: -1;
	  width: 100px;
	  height: 30px;
	  border-radius: 50px;
	  filter: blur(10px);
	  content: "";
	  transition: .5s;
	}
	
	.btn:hover::before {
	  background-color: #0cbcf2;
	  transform: scale(2);
	}
	
	.add-btn {
	  background-color: #D3D3D3;
	  border: solid;
	  color: black;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  cursor: pointer;
	  float: left;
	}
	
	.del-btn {
	  background-color: #ff0000;
	  border: solid;
	  color: black;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  cursor: pointer;
	  float: left;
	}
	
	.label-class {
		float: left;
	}
	
	.mand:after {
		color: #e32;
		content: ' *';
		display:inline;
	}
	
	span {
		display: block;
		overflow: hidden;
		padding: 0px 4px 0px 6px
	}
	
	.alert-success {
		display: none;
	}
    
	#receiptForm {
		height:500px;
		overflow-y:auto;
	}
	
	.hidden {
		display: none;
    }
	
</style>
</head>
<body>
	<div class="container">

            <div id="messages" class="hide" role="alert">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <div id="messages_content"></div>
            </div>
	<div id="container">
    <div class="centered">
    <div class="form-wrap" id="receiptForm">
        <form>
            <div><h2> Homegrown Produce Receipt Form </h2></div>
			<div><h4> <i>(All fields within <b style="color: #e32;">*</b> must be completed)</i> </h4></div>
			<div><h5><i>To be completed by Lela (when handing off to Fran)</i></h5></div>
			<div>
            <label class="mand label-class">First Name:</label>
			<span><input type="text" name="fname" id="fname" pattern="^[^\d]+$" title="Enter a valid name" value="" required></span>
			</div>
			<div>
            <label class="mand label-class">Last Name:</label>
			<span><input type="text" name="lname" id="lname" pattern="^[^\d]+$" title="Enter a valid name" value="" required></span>
			</div>
			<div>
            <label class="label-class mand">Produce Transfer Date:</label>
			<span><input type="date" id="pickupdate" name="pickupdate" required></span>
			</div>
			<div>
            <label class="label-class mand">Produce Transfer Time:</label>
			<span><input type="time" id="pickuptime" name="pickuptime" required></span>
			</div>
			<div>
            <label class="label-class mand">Produce Transfer Location:</label>
			<span><input type="text" name="pickuplocation" id="pickupadd" title="Enter a valid address" value="" required></span>
			</div>
		<div id="produce-details">
            
			</div>
			<div><input type="button" class="add-btn" value="Add a produce" onclick="addProduceDetails()"></div><br><br><br><br>
			<div>
			<label class="mand label-class">Upload a Photo:</label>
			<span><input type="file" multiple="" data-max_length="5" accept=".jpg,.jpeg, .png" title="Enter a valid name" name="receiptphoto" id="receipt-photo" required></span>
			</div>
			<div><h5><i><b>Note:</b>&nbsp;Please Upload a Closeup of the Produce item(s). Also, to select multiple files, hold down the CTRL or SHIFT key while selecting.</i></h5></div>
			<div>
			<label class="label-class">Comments:</label>
			<span><input type="text" title="Enter comments" name="comments"></span>
			<span><input type="hidden" name="cropsreceivedlist" id="cropsreceivedlist"></span>
			<span><input type="hidden" name="produceidlist" id="produceidlist"></span>
			<span><input type="hidden" name="quantitylist" id="quantitylist"></span>
			<span><input type="hidden" name="unitslist" id="unitslist"></span>
			</div><br>
            <button type="Submit" class="btn">Submit ></button><br>			
			<div><img src="images/homegrown-logo-new-final.png" alt="Homegrown Logo" style="width: 120px; height: 120px; margin-left: 170px;">
			</div>
        </form>
    </div>
    </div>
	</div>
	</div>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script>

function addProduceDetails() {
	const div = document.createElement('div');

  div.className = 'new-produce';

  div.innerHTML = `
    <div>
			<label class="mand label-class">Crops Transferred:</label>
			<span>
				<select name="cropsList" id="cropsList" required>
				<option value="">-Select-</option> 
				<option value="TOMATO">Tomato</option>
				<option value="YELLOW ONION">Yellow Onion</option>
				<option value="RED ONION">Red Onion</option>
				<option value="GARLIC">Garlic</option>
				<option value="SWEET POTATO">Sweet Potato</option>
				<option value="RED BELL PEPPER">Red Bell Pepper</option>
				<option value="SERRANO PEPPER">Serrano Pepper</option> 
				<option value="JALAPEÑO PEPPER">Jalapeño Pepper</option>
				<option value="HABANERO PEPPER">Habanero Pepper</option>
				<option value="SCOTCH BONNET PEPPER">Scotch Bonnet Pepper</option>
				<option value="CILANTRO">Cilantro</option>
				<option value="PARSLEY">Parsley</option>
				<option value="SHALLOTS">Shallots</option>
				<option value="GREEN ONION">Green Onion</option>
				<option value="BASIL">Basil</option>
				<option value="CAYENNE PEPPER">Cayenne Pepper</option>
				</select>
			</span>
			</div>
			<div>
            <label class="mand label-class">Produce ID:</label>
			<span><input type="text" id="produceid" name="produceid"></span>
			</div>
			<div>
            <label class="mand label-class">Quantity (with units):</label>
			<span>
				<input type="text" class="quantext" id="quantity" name="quantity">
				<select name="units" class="shortselect" id="units" required>
					<option value="">-Select-</option> 
					<option value="lb">lb</option>
					<option value="count">count</option>
     					<option value="bunches">bunches</option>
				</select>
			</span>
			</div>
    <input type="button" class="del-btn" value="Delete Produce" onclick="removeProduceDetails(this)" /><br><br><br><br>
  `;

  document.getElementById('produce-details').appendChild(div);
}

function removeProduceDetails(input) {
  document.getElementById('produce-details').removeChild(input.parentNode);
}

// Get the form element
const form = document.querySelector('form');

// Add a submit event listener to the form
form.addEventListener('submit', function(event) { debugger;

const produceIds = [];
const cropsReceived = [];
const quantities = [];
const unitsList = [];
						 
    const produceDivs = document.querySelectorAll('.new-produce');
    
    produceDivs.forEach(function(produceDiv) {
        const produceIdInput = produceDiv.querySelector('#produceid');
        if (produceIdInput && produceIdInput.value) {
            produceIds.push(produceIdInput.value);
	    document.getElementById('produceidlist').value = produceIds.join(', ');
        }
	    
	const cropsInput = produceDiv.querySelector('#cropsList');
        if (cropsInput && cropsInput.value) {
            cropsReceived.push(cropsInput.value);
	    document.getElementById('cropsreceivedlist').value = cropsReceived.join(', ');
        }
	    
	const quantitiesInput = produceDiv.querySelector('#quantity');
        if (quantitiesInput && quantitiesInput.value) {
            quantities.push(quantitiesInput.value);
	    document.getElementById('quantitylist').value = quantities.join(', ');
        }
	    
	const unitsInput = produceDiv.querySelector('#units');
        if (unitsInput && unitsInput.value) {
            unitsList.push(unitsInput.value);
	    document.getElementById('unitslist').value = unitsList.join(', ');
        }
    });

    const formData = new FormData(this);
    const fileInput = document.getElementById('receipt-photo');
      const files = fileInput.files;

      if (files.length > 0) {
        const fileReaders = [];
        const base64Strings = [];
        const fileTypes = [];

        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = function(e) {
            base64Strings.push(e.target.result.split(',')[1]); // Base64 string
            fileTypes.push(files[i].type); // File MIME type
            if (base64Strings.length === files.length) {
              formData.append('photoData', JSON.stringify(base64Strings));
              formData.append('fileTypes', JSON.stringify(fileTypes));
	      sendData(formData);
	    }
	  };

	  reader.onerror = function(e) {
	        console.error("Error reading file: ", files[i].name, e);
	  };

	  reader.readAsDataURL(files[i]);
	}
      } else {
	sendData(formData);
      }		  
});
    
function sendData(formData) {
    const data = {};
    formData.forEach((value, key) => {
      data[key] = value;
    });
    
    fetch('https://script.google.com/macros/s/AKfycbyj1_yrc9Zs4bIRzMitD_39HUXCTdB7KXV4wGqpsnqtbMjqbttkiuM9DWWR0XczJ4ac/exec', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8',
      },
      body: JSON.stringify(data),
    })
    .then(response => response.text())
    .then(result => {
      console.log('Success:', result);
      // Handle the success response here
    })
    .catch(error => {
      console.error('Error:', error);
      // Handle the error here
    });
  
	$('#messages').removeClass('hide').addClass('alert alert-success alert-dismissible').slideDown().show();
	$('#messages_content').html('<h4>Form Submitted Successfully!</h4>');
	event.preventDefault();  
}

</script>
</body>
</html>
